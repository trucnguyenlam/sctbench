# Top level makefile for the project.

CXX=g++-4.9
CC=gcc-4.9

########## CHANGE ACCORDINGLY ###########

compiletype ?= debug
packages := core tracer sinst pct randsched race systematic idiom
user_flags := -D_USING_DEBUG_INFO

########## DO NOT CHANGE BELOW ##########

# define source and build dir
ifeq ($(compiletype), debug)
  DEBUG := 1
endif

# include Protobuf environment
include protobuf.mk

# include PIN environment
include pin.mk

# define source, script, build dir
srcdir := src/
scriptdir := script/
protoscriptdir := $(scriptdir)maple/proto/
ifeq ($(compiletype), debug)
  builddir := build-debug/
else ifeq ($(compiletype), release)
  builddir := build-release/
else
  $(error Please specify compile type correctly, debug or release.)
endif

# process rules for each package
$(foreach pkg,$(packages),$(eval include $(srcdir)$(pkg)/package.mk))
$(foreach pkg,$(packages),$(eval objdirs += $(builddir)$(pkg)/))
protosrcs := $(protodefs:%.proto=$(srcdir)%.pb.cc)
protohdrs := $(protodefs:%.proto=$(srcdir)%.pb.h)
protoscripts := $(protodefs:%.proto=$(protoscriptdir)%_pb2.py)
protopkgscripts := $(sort $(patsubst %,$(protoscriptdir)%__init__.py,$(dir $(protodefs))) $(protoscriptdir)__init__.py)
cxxsrcs := $(filter %.cc,$(srcs:%=$(srcdir)%))
pincxxsrcs := $(filter %.cpp,$(srcs:%=$(srcdir)%))
cxxobjs := $(cxxsrcs:$(srcdir)%.cc=$(builddir)%.o)
pincxxobjs := $(pincxxsrcs:$(srcdir)%.cpp=$(builddir)%.o)
pintool_names := $(basename $(pintools))
cmdtool_names := $(basename $(cmdtools))
pintools := $(pintools:%=$(builddir)%)
cmdtools := $(cmdtools:%=$(builddir)%)
$(foreach name,$(pintool_names),$(eval $(name)_objs := $($(name)_objs:%=$(builddir)%)))
$(foreach name,$(cmdtool_names),$(eval $(name)_objs := $($(name)_objs:%=$(builddir)%)))

# set compile flags
ifeq ($(compiletype), debug)
  CFLAGS += -Wall -D_DEBUG -O0 -g -fno-omit-frame-pointer
  # -Werror
  CXXFLAGS += -Wall -D_DEBUG -O0 -g -fno-omit-frame-pointer
  # -Werror
else
  # change to O2 for safer build
  CFLAGS += -O2 -fomit-frame-pointer
  CXXFLAGS += -O2 -fomit-frame-pointer
endif
CFLAGS += -fPIC -D_GNU_SOURCE $(user_flags)
#-finstrument-functions
CXXFLAGS += -fPIC -std=c++11 -D_GNU_SOURCE $(user_flags)
# CXXFLAGS += -D_GLIBCXX_USE_CXX11_ABI=0
# CXXFLAGS += -fabi-version=2
#-finstrument-functions
INCS := -I$(srcdir) -I$(PROTOBUF_HOME)/include
LDFLAGS +=
LPATHS += -L$(PROTOBUF_HOME)/lib -Wl,-rpath,$(PROTOBUF_HOME)/lib
LIBS += -pthread -lprotobuf

PIN_CXXFLAGS += $(TOOL_CXXFLAGS)
PIN_LIBS += $(TOOL_LIBS)
PIN_LDFLAGS += $(TOOL_LDFLAGS)
PIN_LPATHS += $(TOOL_LPATHS)
PIN_LD += g++
OUTOPT = -o
LINK_OUT = -o

PIN_LDFLAGS +=
PIN_LPATHS += -L$(PROTOBUF_HOME)/lib -Wl,-rpath,$(PROTOBUF_HOME)/lib
PIN_LIBS += -lrt -lprotobuf

# gen dependency
cxxgendepend = $(CXX) $(CXXFLAGS) $(INCS) -MM -MT $@ -MF $(builddir)$*.d $<
pincxxgendepend = $(CXX) $(CXXFLAGS) $(PIN_CXXFLAGS) $(INCS) -MM -MT $@ -MF $(builddir)$*.d $<

# rules
.SECONDEXPANSION:

all: $(pintools) $(cmdtools) proto-scripts

proto-scripts: $(protoscripts) $(protopkgscripts)

$(cxxobjs) : | $(objdirs)

$(pincxxobjs) : | $(objdirs)

$(protoscripts) : | $(protoscriptdir)

$(cxxobjs) : $(protosrcs) $(protohdrs)

$(pincxxobjs) : $(protosrcs) $(protohdrs)

$(protopkgscripts) : $(protoscripts)

$(objdirs):
	mkdir -p $@

$(protoscriptdir):
	mkdir -p $@

$(protosrcs): $(srcdir)%.pb.cc : $(srcdir)%.proto
	$(PROTOC) -I=$(srcdir) --cpp_out=$(srcdir) $<

$(protohdrs): $(srcdir)%.pb.h : $(srcdir)%.proto
	$(PROTOC) -I=$(srcdir) --cpp_out=$(srcdir) $<

$(protoscripts): $(protoscriptdir)%_pb2.py : $(srcdir)%.proto
	$(PROTOC) -I=$(srcdir) --python_out=$(protoscriptdir) $<

$(protopkgscripts):
	touch $@

$(cxxobjs): $(builddir)%.o : $(srcdir)%.cc
	@$(cxxgendepend);
	$(CXX) -c $(CXXFLAGS) $(INCS) -o $@ $<

$(pincxxobjs): $(builddir)%.o : $(srcdir)%.cpp
	@$(pincxxgendepend);
	$(CXX) -c $(CXXFLAGS) $(PIN_CXXFLAGS) $(INCS) ${OUTOPT}$@ $<

$(pintools): $(builddir)%.so : $$(%_objs)
	$(PIN_LD) $(PIN_LDFLAGS) $(LINK_DEBUG) ${LINK_OUT}$@ $^ ${PIN_LPATHS} $(PIN_LIBS) $(DBG)

$(cmdtools): $(builddir)% : $$(%_objs)
	$(CXX) $(LDFLAGS) -o $@ $^ $(LPATHS) $(LIBS)

clean:
	rm -rf build-debug build-release
	rm -f $(protosrcs) $(protohdrs)
	rm -rf $(protoscriptdir)

# include dependencies
-include $(cxxsrcs:$(srcdir)%.cc=$(builddir)%.d)
-include $(pincxxsrcs:$(srcdir)%.cpp=$(builddir)%.d)

